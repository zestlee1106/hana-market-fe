name: Deploy to NCP

on:
  repository_dispatch:
    types: [deploy]

jobs:
  docker-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # - name: Build and deploy
      #   run: |
      #     echo "$SSH_PEM_KEY" >> $HOME/key.pem
      #     chmod 400 $HOME/key.pem
      #     ssh -i $HOME/key.pem -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_KNOWN_HOSTS} '~/script.sh'
      #   env:
      #     SSH_USER: ${{secrets.SSH_USER}}
      #     SSH_KNOWN_HOSTS: ${{secrets.SSH_KNOWN_HOSTS}}
      #     SSH_PEM_KEY: ${{secrets.SSH_PEM_KEY}}

      # # AWS 로그인
      # - name: Configure AWS credentials
      #   uses: aws-actions/configure-aws-credentials@v1
      #   with:
      #     aws-access-key-id: ${{ secrets.ACCESS_KEY }}
      #     aws-secret-access-key: ${{ secrets.SECRET_KEY }}
      #     aws-region: ap-northeast-2

      - name: Copy Docker Compose file to NCP Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_URL }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.PEM }}
          port: ${{ secrets.EC2_PORT }}
          source: docker-compose.yml
          target: /deploy/scripts

      # - name: Connect ssh to NCP Server
      # uses: appleboy/ssh-action@master
      # with:
      #   host: ${{ secrets.NCP_SERVER_IP }}
      #   username: ${{ secrets.NCP_SERVER_USERNAME }}
      #   password: ${{ secrets.NCP_SERVER_PASSWORD }}
      #   port: ${{ secrets.NCP_SERVER_PORT }}
      #   script: |
      #     cd /deploy/scripts
      #     echo ${{ secrets.NCP_NCR_SECRET_KEY }} | docker login -u ${{ secrets.NCP_NCR_ACCESS_KEY }} --password-stdin ${{ secrets.NCP_NCR }}
      #     docker pull ${{ secrets.NCP_NCR }}/${{env.IMAGE_NAME}}:latest
      #     export BUILD_NUMBER=latest
      #     export NCP_NCR=${{ secrets.NCP_NCR }}
      #     export IMAGE_NAME=${{ env.IMAGE_NAME }}
      #     if [[ $(docker ps -q) ]]; then
      #       docker stop $(docker ps -q)
      #       docker rm $(docker ps -aq)
      #     else
      #       echo "No running containers found."
      #     fi
      #     docker-compose up -d
      #     docker logout
